# Interpersonal

The connection between my little site and the Indie Web.

## Implementation

This code benefitted greatly from <https://unrelenting.technology>'s
[Sellout Engine](https://github.com/unrelentingtech/sellout),
and also from the [Flask tutorial](https://flask.palletsprojects.com/en/2.0.x/tutorial/).

### WSGI, not ASGI

I implemented Interpersonal as a WSGI Flask app, rather than follow Sellout Engine's design of an ASGI Starlette app. In retrospect, this might not have been the best plan, as ASGI is more modern, but I wanted to use WSGI. The benefits of ASGI probably don't apply to my sites, and I already have WSGI infrastructure and experience, so I don't regret this too much. If you want to use Interpersonal for a large, multi-user site, however, you might run into scaling issues.

See also: <https://www.475cumulus.com/single-post/2017/04/03/WSGI-Is-Not-Enough-Anymore>

## Development

Set up a venv:

```sh
python3 -m venv interpersonal.venv
. interpersonal.venv/bin/activate
pip install -e .
```

Run in development mode.
Note that you can set the owner profile to a dummy example URL
and still see some pages and make all the tests work.
You can also set it to a live site or a site you're running locally.
See `dev.conf.yml` for configuration.

```sh
. dev.env
flask init-db  # Initialize the database
flask run --debugger  # Run the webserver
```

Run the tests and code coverage:

```sh
# Run just the tests
pytest

# Calculate code coverage
coverage run -m pytest
coverage report
```

To run the e2e tests against the real github repo, you need a repo to run against.
Mine is <https://github.com/mrled/interpersonal-test-blog>.
Then:

```sh
export INTERPERSONAL_TEST_GITHUB_BLOG_URI=https://interpersonal-test-blog.netlify.app/
export INTERPERSONAL_TEST_GITHUB_OWNER=mrled
export INTERPERSONAL_TEST_GITHUB_REPO=interpersonal-test-blog
export INTERPERSONAL_TEST_GITHUB_TOKEN=<my personal github token>

INTERPERSONAL_TEST_GITHUB_RUN_E2E_TESTS=true pytest tests/test_e2e_github.py
```

Note that actually deploying this on Netlify (or anywhere else) is not necessary,
as you can just check the status of your commits on github.com.
The blog URI isn't used for anything either.
That said, in this case I did actually deploy to Netlify, so that is a real URL.
(Is it weird that it's satisfying to see my test posts show up on the deployed site?)

### Cert errors on macOS

For some reason you have to run `sudo /Applications/Python\ $version/Install\ Certificates.command` (e.g. for Python 3.9 `sudo /Applications/Python\ 3.9/Install\ Certificates.command`) to fix certificate errors when running on macOS.

If you're getting errors like `CERTIFICATE_VERIFY_FAILED` when trying to talk to the Github API, this may be your issue.

## Production

Interpersonal is a pretty standard Flask app.

First, write a config file somewhere.
See `dev.config.yml` for an example.
To create a good cookie secret, run something like:

```sh
python3 -c 'import base64, os; print(base64.b64encode(os.urandom(32)).decode())'
```

Create a virtual environment somewhere and install dependencies,
then configure the app:

```sh
python3 -m venv /path/to/interpersonal.venv
. /path/to/interpersonal.venv/bin/activate

cd /path/to/interpersonal-git-repo
pip install -e .

export INTERPERSONAL_CONFIG=/path/to/interpersonal.config.yml
export FLASK_APP=interpersonal

flask init-db

# Make note of this secret key, it is used in apache config later
echo "$INTERPERSONAL_COOKIE_SECRET_KEY"
```

Then create a WSGI file.
Note that you must hard-code the config path.
(You might think that you can instead use environment variables
with Apache's `SetEnv`, but this doesn't work:
<https://stackoverflow.com/questions/9016504/apache-setenv-not-working-as-expected-with-mod-wsgi>.)

```py
from interpersonal import create_app
application = create_app(configpath="/path/to/interpersonal.config.yml")
```

Finally, configure Apache to call the WSGI file:

```apache
<VirtualHost *>
    ServerName example.com

    WSGIDaemonProcess interpersonal user=user1 group=group1 threads=5 \
        python-home=/path/to/interpersonal.venv
    WSGIScriptAlias / /var/www/interpersonal/interpersonal.wsgi.py

    <Directory /var/www/interpersonal>
        WSGIProcessGroup interpersonal
        WSGIApplicationGroup %{GLOBAL}
        Order deny,allow
        Allow from all
    </Directory>
</VirtualHost>
```

## Tokens and codes and secrets

There are a few different kinds of unguessable ("secret") blobs of data,
all of which might easily be termed "tokens" or "codes" or "secrets".

* The login password: This is entered by the user (me) to log in.
    I am the only user for this site, so I don't have a 'users' table containing this value;
    instead I have a singular 'login_password' value in the AppSettings table,
    and I present only a password entry box on the login page.
* The authorization code: Generated by `indieauth.grant()`,
    this value is created from random data when the user logs in and authorizes a given app.
    It is stored in the `AuthorizationCode` table.
    Defined by the IndieAuth spec.
    Sellout Engine prefixes these values with `C-`.
* The bearer token: The application exchanges its authorization code for one of these.
    The exchange happens in `indieauth.bearer()`.
    Also created from random data.
    Stored in the `BearerToken` table.
    (I'm not really issuiing bearer tokens yet, but I will eventually.)
    Defined by the IndieAuth spec.
    Sellout Engine prefixes these values with `B-`.

## How to use this to authenticate to an application that understands IndieAuth?

* Deploy it for production (per above) and note the URI, like `interpersonal.example.com`.
* On your own website at your own domain, add a link with the appropriate `rel` attribute, like
  `<link rel="authorization_endpoint" href="https://interpersonal.example.com/indieauth/authorize">`

## TODO

* Should move to oauth token for github blogs, not a personal token which can access any private repo
